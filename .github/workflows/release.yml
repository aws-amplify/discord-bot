name: release
on:
  pull_request:
    branches:
      - main
    types:
      - closed
jobs:
  verify-run:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true && startsWith(github.event.pull_request.head.ref, 'release/')
    outputs:
      tag: ${{ steps.tag.outputs.result }}
      is-prerelease: ${{ contains(steps.tag.outputs.result, 'next') }}
    steps:
      - name: extract-tag-name
        id: tag
        uses: actions/github-script@0.2.0
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            return context.payload.pull_request.title.replace(/release\: /, '');
  prerelease:
    needs: verify-run
    if: ${{ fromJSON(needs.verify-run.outputs.is-prerelease) == true }}
    uses: ./.github/workflows/release-env.yml
    with:
      env: next
      version: ${{ needs.verify-run.outputs.tag }}
      is-prerelease: true
  release:
    needs: verify-run
    if: ${{ fromJSON(needs.verify-run.outputs.is-prerelease) == false }}
    uses: ./.github/workflows/release-env.yml
    with:
      env: main
      version: ${{ needs.verify-run.outputs.tag }}
      is-prerelease: false
